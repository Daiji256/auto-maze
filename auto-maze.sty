%% This is file `auto-maze.sty'.
%% Copyright 2021 Daiji SUZUKI

\RequirePackage{expl3, xparse, l3keys2e, tikz}

\ExplSyntaxOn

\int_new:N  \l_atmz_wall_int % 0
\int_new:N  \l_atmz_road_int % not wall
\int_set:Nn \l_atmz_wall_int { 0 }
\int_set:Nn \l_atmz_road_int { 1 }

\int_new:N  \l_atmz_loop_i_int      % loop i
\int_new:N  \l_atmz_loop_j_int      % loop j
\int_new:N  \l_atmz_x_int           % x
\int_new:N  \l_atmz_y_int           % y
\int_new:N  \l_atmz_maze_width_int  % maze width (odd)
\int_new:N  \l_atmz_maze_height_int % maze height (odd)
\prop_new:N \l_atmz_maze_prop       % maze data, key(i * width + j) => (road, wall)
\int_new:N  \l_atmz_tmp_int         % tmp
\int_new:N  \l_atmz_key_int         % i * width + j
\int_new:N  \l_atmz_key_left_int    % key - 1
\int_new:N  \l_atmz_key_top_int     % key - width
\int_new:N  \l_atmz_rand_int        % random int
\seq_new:N  \l_atmz_rand_box_seq    % tl, randint(0, 2^18 - 1) * 2^12 + randint(0, (height - 1) * (width - 1) - 1)
\prop_new:N \l_atmz_check_prop      % check rand box
\bool_new:N \l_atmz_loop_bool       % loop bool
\int_new:N  \l_atmz_now_int         %

\NewDocumentCommand \mazebar { m m }
  {
    \int_set:Nn \l_atmz_maze_width_int  { #1 * 2 - 1 }
    \int_set:Nn \l_atmz_maze_height_int { #2 * 2 - 1 }

    % all road
    \int_set:Nn \l_atmz_loop_i_int { 0 }
    \int_do_while:nn { \l_atmz_loop_i_int < \l_atmz_maze_height_int }
      {
        \int_set:Nn \l_atmz_loop_j_int { 0 }
        \int_do_while:nn { \l_atmz_loop_j_int < \l_atmz_maze_width_int }
          {
            \int_set:Nn \l_atmz_key_int { \l_atmz_loop_i_int * \l_atmz_maze_width_int + \l_atmz_loop_j_int }
            \prop_put:NVn \l_atmz_maze_prop \l_atmz_key_int { \l_atmz_road_int }
            \int_incr:N \l_atmz_loop_j_int
          }
        \int_incr:N \l_atmz_loop_i_int
      }

    % first line
    \int_set:Nn \l_atmz_loop_i_int { 1 }
    \int_set:Nn \l_atmz_loop_j_int { 1 }
    \int_do_while:nn { \l_atmz_loop_j_int < \l_atmz_maze_width_int }
      {
        \int_set:Nn \l_atmz_key_int { \l_atmz_loop_i_int * \l_atmz_maze_width_int + \l_atmz_loop_j_int }
        \prop_put:NVn \l_atmz_maze_prop \l_atmz_key_int { \l_atmz_wall_int }
        \int_set:Nn \l_atmz_key_left_int { \l_atmz_key_int - 1 }
        \prop_get:NVN \l_atmz_maze_prop \l_atmz_key_left_int \l_atmz_left_value_int
        \int_compare:nNnTF { \l_atmz_left_value_int } = { \l_atmz_wall_int }
          {
            \int_set:Nn \l_atmz_rand_int { \fp_eval:n { randint(0, 2) } }
            \int_compare:nNnT { \l_atmz_rand_int } = { 0 }
              { \int_set:Nn \l_atmz_tmp_int { \l_atmz_key_int + 1 } }
            \int_compare:nNnT { \l_atmz_rand_int } = { 1 }
              { \int_set:Nn \l_atmz_tmp_int { \l_atmz_key_int + \l_atmz_maze_width_int } }
            \int_compare:nNnT { \l_atmz_rand_int } = { 2 }
              { \int_set:Nn \l_atmz_tmp_int { \l_atmz_key_int - \l_atmz_maze_width_int } }
            \prop_put:NVn \l_atmz_maze_prop \l_atmz_tmp_int { \l_atmz_wall_int }
          }
          {
            \int_set:Nn \l_atmz_rand_int { \fp_eval:n { randint(0, 3) } }
            \int_compare:nNnT { \l_atmz_rand_int } = { 0 }
              { \int_set:Nn \l_atmz_tmp_int { \l_atmz_key_int + 1 } }
            \int_compare:nNnT { \l_atmz_rand_int } = { 1 }
              { \int_set:Nn \l_atmz_tmp_int { \l_atmz_key_int - 1 } }
            \int_compare:nNnT { \l_atmz_rand_int } = { 2 }
              { \int_set:Nn \l_atmz_tmp_int { \l_atmz_key_int + \l_atmz_maze_width_int } }
            \int_compare:nNnT { \l_atmz_rand_int } = { 3 }
              { \int_set:Nn \l_atmz_tmp_int { \l_atmz_key_int - \l_atmz_maze_width_int } }
            \prop_put:NVn \l_atmz_maze_prop \l_atmz_tmp_int { \l_atmz_wall_int }
          }
        \int_set:Nn \l_atmz_loop_j_int { \l_atmz_loop_j_int + 2 }
      }

    % after second line
    \int_set:Nn \l_atmz_loop_i_int { 3 }
    \int_do_while:nn { \l_atmz_loop_i_int < \l_atmz_maze_height_int }
      {
        \int_set:Nn \l_atmz_loop_j_int { 1 }
        \int_do_while:nn { \l_atmz_loop_j_int < \l_atmz_maze_width_int }
          {
            \int_set:Nn \l_atmz_key_int { \l_atmz_loop_i_int * \l_atmz_maze_width_int + \l_atmz_loop_j_int }
            \prop_put:NVn \l_atmz_maze_prop \l_atmz_key_int { \l_atmz_wall_int }
            \int_set:Nn \l_atmz_key_left_int { \l_atmz_key_int - 1 }
            \prop_get:NVN \l_atmz_maze_prop \l_atmz_key_left_int \l_atmz_left_value_int
            \int_compare:nNnTF { \l_atmz_left_value_int } = { \l_atmz_wall_int }
              {
                \int_set:Nn \l_atmz_rand_int { \fp_eval:n { randint(0, 1) } }
                \int_compare:nNnT { \l_atmz_rand_int } = { 0 }
                  { \int_set:Nn \l_atmz_tmp_int { \l_atmz_key_int + 1 } }
                \int_compare:nNnT { \l_atmz_rand_int } = { 1 }
                  { \int_set:Nn \l_atmz_tmp_int { \l_atmz_key_int + \l_atmz_maze_width_int } }
                \prop_put:NVn \l_atmz_maze_prop \l_atmz_tmp_int { \l_atmz_wall_int }
              }
              {
                \int_set:Nn \l_atmz_rand_int { \fp_eval:n { randint(0, 2) } }
                \int_compare:nNnT { \l_atmz_rand_int } = { 0 }
                  { \int_set:Nn \l_atmz_tmp_int { \l_atmz_key_int + 1 } }
                \int_compare:nNnT { \l_atmz_rand_int } = { 1 }
                  { \int_set:Nn \l_atmz_tmp_int { \l_atmz_key_int - 1 } }
                  \int_compare:nNnT { \l_atmz_rand_int } = { 2 }
                  { \int_set:Nn \l_atmz_tmp_int { \l_atmz_key_int + \l_atmz_maze_width_int } }
                \prop_put:NVn \l_atmz_maze_prop \l_atmz_tmp_int { \l_atmz_wall_int }
              }
            \int_set:Nn \l_atmz_loop_j_int { \l_atmz_loop_j_int + 2 }
          }
        \int_set:Nn \l_atmz_loop_i_int { \l_atmz_loop_i_int + 2 }
      }

    % output
    \tl_set:Nn \l_atmz_maze_tl { }
    \tl_put_right:Nn \l_atmz_maze_tl { \begin{tikzpicture}[x=8pt, y=8pt, line~width=1pt, line~cap=round] }
    \int_set:Nn \l_atmz_loop_i_int { 0 }
    \int_do_while:nn { \l_atmz_loop_i_int < \l_atmz_maze_height_int }
      {
        \int_compare:nNnTF { \int_mod:nn { \l_atmz_loop_i_int } { 2 } } = { 0 }
          {
            \int_set:Nn \l_atmz_loop_j_int { 1 }
            \int_do_while:nn { \l_atmz_loop_j_int < \l_atmz_maze_width_int }
              {
                \int_set:Nn \l_atmz_x_int { \l_atmz_loop_j_int / 2 }
                \int_set:Nn \l_atmz_y_int { \l_atmz_loop_i_int / 2 }
                \int_set:Nn \l_atmz_key_int { \l_atmz_loop_i_int * \l_atmz_maze_width_int + \l_atmz_loop_j_int }
                \prop_get:NVN \l_atmz_maze_prop \l_atmz_key_int \l_atmz_maze_value_int
                \int_compare:nNnT { \l_atmz_maze_value_int } = { \l_atmz_wall_int }
                  {
                    \tl_put_right:Nx \l_atmz_maze_tl
                      {
                        \exp_not:N \draw (\int_use:N \l_atmz_x_int, \int_use:N \l_atmz_y_int)--++(0, 1);
                      }
                  }
                \int_set:Nn \l_atmz_loop_j_int { \l_atmz_loop_j_int + 2 }
              }
          }
          {
            \int_set:Nn \l_atmz_loop_j_int { 0 }
            \int_do_while:nn { \l_atmz_loop_j_int < \l_atmz_maze_width_int }
              {
                \int_set:Nn \l_atmz_x_int { \l_atmz_loop_j_int / 2 }
                \int_set:Nn \l_atmz_y_int { \l_atmz_loop_i_int / 2 }
                \int_set:Nn \l_atmz_key_int { \l_atmz_loop_i_int * \l_atmz_maze_width_int + \l_atmz_loop_j_int }
                \prop_get:NVN \l_atmz_maze_prop \l_atmz_key_int \l_atmz_maze_value_int
                \int_compare:nNnT { \l_atmz_maze_value_int } = { \l_atmz_wall_int }
                  {
                    \tl_put_right:Nx \l_atmz_maze_tl
                      {
                        \exp_not:N \draw (\int_use:N \l_atmz_x_int, \int_use:N \l_atmz_y_int)--++(1, 0);
                      }
                  }
                \int_set:Nn \l_atmz_loop_j_int { \l_atmz_loop_j_int + 2 }
              }
          }
        \int_incr:N \l_atmz_loop_i_int
      }
    \int_set:Nn \l_atmz_x_int { \l_atmz_maze_width_int / 2 }
    \int_set:Nn \l_atmz_y_int { \l_atmz_maze_height_int / 2 }
    \tl_put_right:Nx \l_atmz_maze_tl
      {
        \exp_not:N \draw (1, \int_use:N \l_atmz_y_int)--++(\int_use:N \l_atmz_x_int - 2, 0);
        \exp_not:N \draw (0, 0)--++(\int_use:N \l_atmz_x_int, 0);
        \exp_not:N \draw (0, 0)--++(0, \int_use:N \l_atmz_y_int);
        \exp_not:N \draw (\int_use:N \l_atmz_x_int, 0)--++(0, \int_use:N \l_atmz_y_int);
      }
    \tl_put_right:Nn \l_atmz_maze_tl { \end{tikzpicture} }
    \tl_use:N \l_atmz_maze_tl

    \prop_clear:N \l_atmz_maze_prop
  }

\NewDocumentCommand \mazedig { m m }
  {
    \int_set:Nn \l_atmz_maze_width_int  { #1 * 2 + 3 }
    \int_set:Nn \l_atmz_maze_height_int { #2 * 2 + 3 }

    % all wall
    \int_set:Nn \l_atmz_loop_i_int { 1 }
    \int_do_while:nn { \l_atmz_loop_i_int < \l_atmz_maze_height_int - 1 }
      {
        \int_set:Nn \l_atmz_loop_j_int { 1 }
        \int_do_while:nn { \l_atmz_loop_j_int < \l_atmz_maze_width_int - 1 }
          {
            \int_set:Nn \l_atmz_key_int { \l_atmz_loop_i_int * \l_atmz_maze_width_int + \l_atmz_loop_j_int }
            \prop_put:NVn \l_atmz_maze_prop \l_atmz_key_int { \l_atmz_wall_int }
            \int_incr:N \l_atmz_loop_j_int
          }
        \int_incr:N \l_atmz_loop_i_int
      }
    % add frame
    \int_set:Nn \l_atmz_loop_i_int { 0 }
    \int_do_while:nn { \l_atmz_loop_i_int < \l_atmz_maze_height_int }
      {
        \int_set:Nn \l_atmz_key_int { \l_atmz_loop_i_int * \l_atmz_maze_width_int }
        \prop_put:NVn \l_atmz_maze_prop \l_atmz_key_int { \c_max_int }
        \int_set:Nn \l_atmz_key_int { \l_atmz_loop_i_int * \l_atmz_maze_width_int + \l_atmz_maze_width_int - 1 }
        \prop_put:NVn \l_atmz_maze_prop \l_atmz_key_int { \c_max_int }
        \int_incr:N \l_atmz_loop_i_int
      }
    \int_set:Nn \l_atmz_loop_j_int { 0 }
    \int_do_while:nn { \l_atmz_loop_j_int < \l_atmz_maze_width_int }
      {
        \int_set:Nn \l_atmz_key_int { \l_atmz_loop_j_int }
        \prop_put:NVn \l_atmz_maze_prop \l_atmz_key_int { \c_max_int }
        \int_set:Nn \l_atmz_key_int { ( \l_atmz_maze_height_int - 1 ) * \l_atmz_maze_width_int + \l_atmz_loop_j_int }
        \prop_put:NVn \l_atmz_maze_prop \l_atmz_key_int { \c_max_int }
        \int_incr:N \l_atmz_loop_j_int
      }

    \int_set:Nn \l_atmz_tmp_int { ( #1 - 1 ) * ( #2 - 1 ) }
    \int_set:Nn \l_atmz_loop_i_int { 0 }
    \int_do_while:nn { \l_atmz_loop_i_int < \l_atmz_tmp_int }
      {
        \int_set:Nn \l_atmz_rand_int { \fp_eval:n { randint(0, 262143) } * 4096 + \l_atmz_loop_i_int }
        \seq_put_right:Nx \l_atmz_rand_box_seq { \int_use:N \l_atmz_rand_int }
        \int_incr:N \l_atmz_loop_i_int
      }
    \seq_sort:Nn \l_atmz_rand_box_seq
      {
        \int_compare:nNnTF { ##1 } < { ##2 }
          { \sort_return_swapped: }
          { \sort_return_same: }
      }

    \bool_set_true:N \l_atmz_loop_bool
    \bool_do_while:Nn \l_atmz_loop_bool
      {
        \bool_set_false:N \l_atmz_loop_bool
      }

    % output
    \int_set:Nn \l_atmz_loop_i_int { 0 }
    \int_do_while:nn { \l_atmz_loop_i_int < \l_atmz_maze_height_int }
      {
        \int_set:Nn \l_atmz_loop_j_int { 0 }
        \int_do_while:nn { \l_atmz_loop_j_int < \l_atmz_maze_width_int }
          {
            \int_set:Nn \l_atmz_key_int { \l_atmz_loop_i_int * \l_atmz_maze_width_int + \l_atmz_loop_j_int }
            \prop_get:NVN \l_atmz_maze_prop \l_atmz_key_int \l_atmz_maze_value_int
            \int_compare:nNnTF { \l_atmz_maze_value_int } = { \l_atmz_wall_int }
              { XX } { \phantom{XX} }
            \int_incr:N \l_atmz_loop_j_int
          }
        \\
        \int_incr:N \l_atmz_loop_i_int
      }

    \int_set:Nn \l_atmz_tmp_int { ( #1 - 1 ) * ( #2 - 1 ) }
    \int_set:Nn \l_atmz_loop_i_int { 0 }
    \int_do_while:nn { \l_atmz_loop_i_int < \l_atmz_tmp_int }
      {
        \seq_pop_left:NN \l_atmz_rand_box_seq \l_atmz_aaa_tl
        \l_atmz_aaa_tl \\
        \int_incr:N \l_atmz_loop_i_int
      }

    \prop_clear:N \l_atmz_maze_prop
    \seq_clear:N \l_atmz_rand_box_seq
    \prop_clear:N \l_atmz_check_prop
  }

\cs_new_eq:NN \maze \mazebar

\ExplSyntaxOff
